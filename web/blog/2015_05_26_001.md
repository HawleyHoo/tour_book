# 静态资源（js以及css）发布对比

[原文](http://www.xdarui.com/archives/220.html)

## js与css(以后称为静态资源)文件发布与传统传统发布有什么区别？

### 类似的地方

- 需要更新版本
- 老版本已经被淘汰或存在BUG
- 都有回滚(注1)的需求
- hostfix是一件正常的事

## 不一样的地方

- 静态与后端很多情况下与后端api绑定很重
- 静态资源存在缓存问题
- 开发阶段要考虑很多兼容性问题

## 我们都是怎么做的,对比下差异

- 淘宝

 淘宝作为阿里集团的重要业务部门，其技术一定程序上代表了整个阿里的技术实力。当然其前端的实力不可小觑，从淘宝的网页的源代码中我们可以发现这样向个静态域名：*.tbcdn.com 和 assets.taobaocdn.net 。我理解这两个域是用通过smart dns或类似技术将用户调度到最近的静态节点上。当然我们今天的主题不是这个。
我从淘宝的首页抓一个静态资源文件的地址回来看看：`http://g.tbcdn.cn/??kissy/k/1.3.0/seed-min.js,tbc/search-suggest/1.0.1/meta-min.js,tb/fp/1.0.8/core-min.js,tb/global/1.0.4/global-min.js?t=20130711` 。这里我们可以得到两个信息：1，kiss的更新是通过人肉的版本号更新。2，针对kissy的bug更新（可能造成版本号未更新）是通过?t=20130711这个时间标志去更新的。这里所引出的问题我们暂且不谈，等下现说。

- 小米

 本人不才，窃居小米两年。没能做成什么事，但也参与了一些项目与基础建设。我到了小米以后就跟大伙一起做了一套发布方案。目前小米的云服务(http://i.xiaomi.com)以及米聊(http://miliao.com)和小米的主题市场( http://app.xiaomi.com )都在使用。电商( http://www.xiaomi.com )那块我没参与。
我们的静态域名有 https://s1.mi-img.com 、http://land.xiaomi.net 等等，在i.xiaomi.com的首页中抓一个url回来：https://s1.mi-img.com/res/FOZvbuB/scripts/micloudfe/loader.js 这里可以看到FOZvbuB是版本号（好奇葩啊……）这处版本号其实是脚本从git lab中读取的一个32位的commit版本号(注2)然后再处理成一个7位的N进制版本号。

## 哪种更适用？

作为第二种方案的实践者以及死忠，我必然会说第二种更靠谱了！（节操神马的不重要啦）要分析这个事情，首先要看这两种发布有没有解决我们的静态发布需求：1.更新缓存 2.升级版本。好像都做到了.

淘宝的发布方式实际上在开发测试完成以后，把新的版本更新到静态服务器上，并强制让所有的cdn节点更新。但测试一定靠谱么？不是说人不靠谱，而是说你一定能保证不犯错么？而且另外一个问题也严重，一旦发布出错，回滚怎么办？把整个cdn都回滚了？这成本显然太高了，而且太慢了！昨天晚上（2013年7月11日晚）淘宝评价系统就发布出错，直接导航评价业全挂了。而且竟然用了整整三个小时以上才解决问题！幸好不是首页，要不然……

从这种方式来看，缺点在于：

- 对测试要求过高或者说对测试依赖过重
- 版本更新之后必需要求后端的工程师修改query string。容易忘掉啊
- 回滚是一个老大难问题
- 很多小的isp都会使用内部缓存方案以减少外部流量，query string很可能不生效。（我就掉过这个坑，说起来都是泪啊）我们曾经尝试把mime type改成json，虽然isp不缓存了，但我前端又哭了。。。这种搞法显然不科学
- 静态发布必需与服务器代码发布同时完成，否则很容易出问题

现在再来看看小米方案是怎么做的，我们在提交测试之前会将一个版本提交到线上的服务器（有CDN的），每个静态资源发布完成后都会得到一个唯一的url，这里脚本会帮我们替换到对应的位置。测试通过以后再把这个版本号替换到线上的配制中去。这样做的好处：

- 静态是提前的，而且是增量。静态测试完成后再提交给服务器配制
- 万一发布失败，服务器回滚。由于线上的静态服务器把每个版本都保留了下来，cdn不用管它了。静态资源可以在几秒内完成回滚(看人肉操作速度以及发现问题时间了)
- 我永远不用关心isp缓存问题，因为url变了
- 静态发布完全独立，测试测的全是线上代码。不存在让测试清缓存这种事情存在。

> - 注1 ： 回滚 这种事情在互联网上太正常不过了，业务回滚无非就是让代码变成一个老的版本。但回滚的时间以及回滚的结果非常重要。回滚成功了，但用了三小时，这也太不符合互联网的生存之道了。
> - 注2： commit 版本号 是指git每次文件提交后都会跟据当前提交产生一个32位的版本号，只要文件不修改这个版本号就不会再变。